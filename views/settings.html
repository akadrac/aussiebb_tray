<html>
    <head>
            <style>
                body{
                    transition: all 0.2s ease-in-out;
                    overflow: hidden;
                }
                .mainWrapper{
                    float: left;
                    background: #333;
                    color: #fff;
                    font-family: Arial, "Helvetica Neue", Helvetica, sans-serif;
                    margin: 12px;
                    padding: 13px;
                    border-radius: 10px;
                    
                }
                .mainWrapper:after {
                    content: '';
                    position: absolute;
                    top: 91%;
                    left: 58%;
                    margin-left: -50px;
                    width: 0;
                    height: 0;
                    border-top: solid 25px #333;
                    border-left: solid 25px transparent;
                    border-right: solid 25px transparent;
                }
                section {
                    width: 100%;
                }
                form{
                    float: left;
                    width: 100%;
                }
                input{
                    border: none;
                    border-radius: 5px;
                    padding: 10px;
                    width: 100%;
                }
                input#submit {
                    float: left;
                    margin-top: 8%;
                    width: 100%;
                    background-color: #00a650;
                    color: #333;
                    font-weight: bold;
                    transition: all 0.2s ease-in-out;
                }
                input#submit:hover{
                    background-color: #004b24;
                    color: #fff;
                    cursor: pointer;
                }
                h4{
                    margin-bottom: 5px;
                    margin-top: 10px;
                }
                .header{
                    float: left;
                    margin-bottom: 5px;
                    margin-top: 5px;
                }
                .header img{
                    float: left;
                    width: 50%;
                    margin-left: 5%;
                }
                .header h2{
                    float: left;
                    margin: 0;
                    margin-top: 12px;
                    margin-left: 30px;
                }
                #error{
                    float: left;
                    font-size: 15px;
                    color: #F44336;
                    font-weight: bold;
                }
                #data{
                    margin-top: 10px;
                    float: left;
                }
                span{
                    font-weight: bold;
                    font-size: 15px;
                    color: #039f4e;
                    padding: 3px;
                }
                p{
                    background: rgba(0, 0, 0, 0.47);
                    padding: 5px;
                    box-shadow: inset 1px 1px 22px rgba(0, 0, 0, 0.72);
                    margin: 6px;
                    border-radius: 6px;
                }
                p .string{
                    float: right;
                    color: #fff;
                    font-weight: normal;
                    margin-top: -2px;
                }
                #updateBtn{
                    display: none;
                }
        </style>
    </head>
    <body>
        <div class="mainWrapper">
                <section class="header">
                        <img src="logo-new.png" />
                        <h2>AUNT</h2>
                </section>
                <section id="error"></section>
                <section id="data"></section>
                <form id="creds" onsubmit="event.preventDefault();">
                    <section>
                        <h4 class="username">Username</h4>
                        <input id="username" class="form-control text-input" placeholder="Username">
                    </section>
                    <section>
                        <h4 class="username">Password</h4>
                        <input id="password" type="password" class="form-control text-input" placeholder="password">
                    </section>
                
                    
                    <input id="submit" type="submit" value="Save">
                </form>
                <button id="updateBtn" onClick="ipcRenderer.send('quitAndInstall')"></button>
        </div>
        
        <script>
                        
                const {ipcRenderer} = require('electron');
                const moment = require('moment');

                function formatFileSize(bytes,decimalPoint) {
                    if(bytes == 0) return '0 Bytes';
                    var k = 1000,
                        dm = decimalPoint || 2,
                        sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'],
                        i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
                };

                function formatFileSizeNoUnit(bytes,decimalPoint) {
                    if(bytes == 0) return '0 Bytes';
                    var k = 1000,
                        dm = decimalPoint || 2,
                        i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(dm));
                };

                document.addEventListener("DOMContentLoaded", function(event) { 
                    document.getElementById('submit').click();
                    ipcRenderer.send('window-show');

                    ipcRenderer.on('error', (event, arg) => {  
                        console.log(arg); 
                        document.getElementById('error').innerHtml = "";
                        let div = document.getElementById('error');
                        div.style.color = "red";
                        div.innerHTML = arg;
                    });  
                    
                    ipcRenderer.on('success', (event, arg) => {  
                        console.log(arg); 
                        document.getElementById('error').innerHtml = "";
                        let div = document.getElementById('error');
                        div.style.color = "#00a650";
                        div.style.textAlign = 'center';
                        div.innerHTML = arg;
                    });  

                    ipcRenderer.on('fullData', (event, arg) => {  
                        console.log(arg.usage.down1[0]); 
                        showData(arg);
                    });  
                    
                    // ipcRenderer.on('appLoaded', (event, arg) => {  
                    //     console.log(arg); 
                    //     document.getElementById("username").innerHTML = arg.username;
                    //     document.getElementById("password").innerHTML = arg.password;
                    //     document.getElementById("submit").click();
                    // }); 
                });

                // wait for an updateReady message
                ipcRenderer.on('updateReady', function(event, text) {
                    // changes the text of the button
                    var container = document.getElementById('ready');
                    container.innerHTML = "new version ready!";
                    container.style.display == "block";
                })
                
                document.querySelector('#submit').addEventListener('click', function() {
                    
                    let username = document.getElementById("username").value;
                    let password = document.getElementById("password").value;

                    let dataToNode = {
                        un : username,
                        pw: password
                    };
                    
                    ipcRenderer.send('asynchronous-message', dataToNode );
                });

                function showData(arg){

                    document.getElementById('data').innerHtml = "";
                    let div = document.getElementById('data');
                    
                    planInBytes = arg.usage.allowance1_mb[0]*1048576;
                    console.log('plan in bytes', planInBytes);
                    console.log('data in bytes', arg.usage.left1[0]);

                    avgUse = planInBytes / getDaysTillRoll(arg.usage.rollover[0]);
                    console.log(avgUse); 
                    if(arg.usage.allowance1_mb > 1000000 && arg.usage.allowance1_mb < 99999999){
                        let plan = arg.usage.allowance1_mb/1000000
                        content = "<p><span>Download:</span><span class='string'>"+formatFileSize(arg.usage.down1[0])+"</span></p><p><span>Upload:</span><span class='string'>"+formatFileSize(arg.usage.up1[0])+"</span></p><p>"+"<span>Total Left:</span><span class='string'>" + formatFileSize(arg.usage.left1[0])+"<span>/</span>"+plan+" TB"+"</span></p><p>"+"<span>Updated:</span><span class='string'>" + moment(arg.usage.lastupdated[0]).fromNow() +"</span></p><p>"+"<span>Days in month remaing:</span><span class='string'>" + getDaysTillRoll(arg.usage.rollover[0]) + " day/s<span></p><p><span>Avg daily limit:</span><span class='string'>"+formatFileSize(avgUse)+"</span></p>";
                    }
                    else if( arg.usage.allowance1_mb = 100000000){
                       
                        content = "<p><span>Download:</span><span class='string'>"+formatFileSize(arg.usage.down1[0])+"</span></p><p><span>Upload:</span><span class='string'>"+formatFileSize(arg.usage.up1[0])+"</span></p><p>"+"<span>Total Left:</span><span class='string'>" + formatFileSize(arg.usage.left1[0])+"<span>/</span>"+"Unlimited"+"</span></p><p>"+"<span>Updated:</span><span class='string'>" + moment(arg.usage.lastupdated[0]).fromNow() +"</span></p><p>"+"<span>Days in month remaing:</span><span class='string'>" + getDaysTillRoll(arg.usage.rollover[0]) + " day/s</span></p><p><span>Avg daily limit:</span><span class='string'>"+formatFileSize(avgUse)+"</span></p>";
                    }
                    else{
                        let plan = arg.usage.allowance1_mb/100000
                        content = "<p><span>Download:</span><span class='string'>"+formatFileSize(arg.usage.down1[0])+"</span></p><p><span>Upload:</span><span class='string'>"+formatFileSize(arg.usage.up1[0])+"</span></p><p>"+"<span>Total Left:</span><span class='string'>" + formatFileSize(arg.usage.left1[0])+"<span>/</span>"+plan+" GB"+"</span></p><p>"+"<span>Updated:</span><span class='string'>" + moment(arg.usage.lastupdated[0]).fromNow() +"</span></p><p>"+"<span>Days in month remaing:</span><span class='string'>" + getDaysTillRoll(arg.usage.rollover[0]) + " day/s</span></p><p><span>Avg daily limit:</span><span class='string'>"+formatFileSize(avgUse)+"</span></p>";
                    }
                    
                    console.log(content);
                    div.innerHTML = content;
                    let form = document.getElementById('creds');
                    form.style.display = 'none';
                    let errorDiv = document.getElementById('error');
                    errorDiv.style.display = 'none';
                }


                function getDaysTillRoll(day){


                    const date = new Date();
                    const today = moment(date);

                    if(day < 10){
                        let rd = 0+''+day;
                        rd = moment(new Date(date.getFullYear(), date.getMonth()+1, rd));
                        let d = rd.diff(today,'days');
                        return d;
                    }else{
                        let rd = day;
                        rd = moment(new Date(date.getFullYear(), date.getMonth()+1, rd));
                        let d = rd.diff(today,'days');
                        return d;
                    }
                    
                }

                
            </script>
    </body>
</html>